---
title: "Using the MBAOD package"
author: Andrew C. Hooker
date: '`r Sys.Date()`'
output:
  html_document:
    fig_caption: yes
    number_sections: yes
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
---


# Introduction
The MBAOD (Model Based Adaptive Optimal Design) package can be used to simulate clinical trials using predefined adaptive and optimization rules.  In addition the package can be used to optimize any specific cohort of an actual study using MBAOD.

Adaptive designs (AD), in general, are a way to adapt experiments as your understanding of the system you are studying improves through intermediate analyses of the experimental data.  Adaptive **optimal** design (AOD) uses optimal design theory as a way to design the next stage of your study.  In this package we are assuming the use of **population** models for both the estimation of parameters (analysis of data) as well as for the optimization of the various cohorts of our experiment (see figure \ref{general_schema}). 

![General schematic of a model based adative optimal design. \label{general_schema} ](figures/2013_06_15_PODE_AOD_Hooker/Slide13.png)

This package currently uses PopED, NONMEM, PsN and R to handle the various tasks inherent to simulating and evaluating an MBAOD experiment (see figure \ref{specific_schema}).  The code has been written to be (hopefully) quite modular, so that other tools can easily be switched in place of the current tool set (e.g. PFIM instead of PopED). 

![Specific schematic of MBAOD implemented in the MBAOD package.  The entire process can be repeated multiple times and then the results of those repeated simulations can be summarized using R. \label{specific_schema} ](figures/2013_06_15_PODE_AOD_Hooker/Slide18.png)

This document describes how to install and use the MBAOD (Model Based Adaptive Optimal Design) package.  


# Installation

1. You need to have R installed.  Download the latest version of R from http://www.r-project.org.

2. Install PopED for R (https://github.com/andrewhooker/PopED). To install the latest stable release from CRAN, write at the R command line: 
    
    ```{r, eval=FALSE}
    install.packages("PopED")
    ```
    
3. NONMEM and PsN (http://psn.sf.net) should be installed. 

4. Download the MBAOD package from https://github.com/andrewhooker/MBAOD.  On the right hand side of the page there are links to "Clone in Desktop" and "Download ZIP". Alternatively, if you want to use the latest version of MBAOD but aren't interested in developing the code, you can use the `devtools::install_github()` from the R command line. The `install_github()` 
approach requires that you build a package from source, i.e. `make` and compilers must be installed on your 
system -- see the R FAQ for your operating system ; you may also need to install dependencies manually:

    ```{r, eval=FALSE}
    devtools::install_github("MBAOD",username="andrewhooker")
    ```

# Overview of the MBAOD package

The MBAOD package's main tool is the `mbaod_simulate()` function, which simulates model based adaptive design scenarios. 
The function's main argument `cohorts` accepts a list of cohorts to run. Each cohort, in turn, is a list of, potentially, 4 named lists: "design", "optimize", "simulate" and "estimate". Each list can be `NULL` or a list of elements:
    
* "design" is a list that defines the (initial) design for that cohort. 
* "optimize" is a list that defines what to do for the optimization segment for that cohort.
* "simulate" is a list that defines what to do for the simulation segment for that cohort.
* "estimate" is a list that defines what to do for the estimation segment for that cohort.

There are a number of optional arguments (see `args(mbaod_simulate)`) including:

* `ncohorts` specifies the number of cohorts in the adaptive design procedure. If larger than the length of `cohorts` then 
the cohort information is inhereted from the last cohort in the list.
* `rep` specifies the number of times the adaptive design procedure should be repeated.

The MBAOD package also has a few plotting functions to visualize the output from `mbaod_simulate()`, including `mbaod_vpc()` and `plot_parameter_estimates()`.  In order to show how these tools work we present below some working examples.

# An example: Adaptive design of a PK bridging study from adults to children

In this example we will simulate multiple realizations of a hypothetical clinical trial to bridge the pharmacokinetics (PK) of an adult population into a children.   

## The adult model   
We assume that the drug PK in adults can be described by a one-compartment model  additive and proportional residual error. For each individual $i$ we have: 

$$
\begin{aligned}
y_i=\frac{DOSE_i}{V_i} \cdot e^{-({CL}_i/V_i) \cdot t_i} \cdot (1+\varepsilon_{prop,i}) + \varepsilon_{add,i}
\end{aligned}
$$

We assume a log-normal distribution of parameter values within individuals of the study population, thus, for $P \in (C{L},V)$ we have:

$$ P_i = P_{pop} \cdot e^{\eta_{P,i}}, \; \; \eta_{P,i} \in N(0,\omega^2_{P})$$

## The maturation model   
There are several methods that can be used to describe the link between PK in adults and 
children. For this example we use a relatively simplistic approach assuming an emax maturation function for CL dependent on weight (WT) as well as a weight adjusted volume parameter:

$$ 
  \begin{aligned}
  {CL}_i & = {CL}_{BASE,i} + \frac{{CL}_{MAX} \cdot {WT}_i^\gamma }{{WT50}^\gamma + {WT}_i^\gamma } \\    
  V_i & = V_{STD,i} \cdot  \frac{{WT}_i}{70}
  \end{aligned}
$$

Where $V_{STD,i}$ and ${CL}_{BASE,i}$ are assumed log-normally distributed as above.

## The Design   
In this study we begin by simulating an initial cohort of adult patients using a fixed design.  Parameter estimates from that initial cohort are then used to optimize the  next cohort.  The commands found below are also available as an R script in the code repository in the directory   
The first example we will look at is labelled "Example_1_poped_r" in the "examples" folder of the MBAOD package. In this directory there are three things of interest:

1. "Example_1.R" - an R script to run all the code presented here.
2. "NONMEM_files" - the NONMEM model and data files needed to run this example.
3. "PopED_files" - The PopED model needed to run this example.


```{r}
    devtools::load_all("/Users/ahooker/Documents/_PROJECTS/AOD/repos/MBAOD")
    args(mbaod_simulate)
```



"design" is a list that defines the initial design for that cohort. The elements of this list are passed to the function `create_design` to create a design object.  

```{r}
    args(create_design)
```

The allowed arguments shown above are defined (until I write documentation for this function) in the documentation for `?PopEd::create.poped.database`.  Look in the "Arguments" section, under "START OF INITIAL DESIGN OPTIONS".


